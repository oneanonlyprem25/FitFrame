<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
<meta name="description" content="Free online image editor. Batch edit, Crop, Rotate, Filter, and Resize images securely in your browser." />
<title>FitFrame Pro â€” Studio</title>

<link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiRml0RnJhbWUgUHJvIiwic2hvcnRfbmFtZSI6IkZpdEZyYW1lIiwic3RhcnRfdXJsIjoiLi8iLCJkaXNwbGF5IjoiYnJvd3NlciIsImJhY2tncm91bmRfY29sb3IiOiIjMGYxMDE0IiwidGhlbWVfY29sb3IiOiIjNjM2NmYxIn0=" />
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236366f1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1'/%3E%3Cpath d='M19 9h1a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-9a2 2 0 0 1-2-2v-1'/%3E%3Cpath d='M10 9h4a1 1 0 0 1 1 1v4'/%3E%3C/svg%3E" type="image/svg+xml">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

<style>
  :root {
    --font-brand: 'Space Grotesk', sans-serif; 
    --bg-body: #0f1014; --bg-panel: #18181b; --bg-input: #27272a;
    --border: #3f3f46; --text-main: #f4f4f5; --text-muted: #a1a1aa;
    --primary: #6366f1; --primary-hover: #4f46e5;
    --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
    --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
  }
  html { scroll-behavior: smooth; }
  * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

  /* Header */
  .topbar { height: 60px; padding: 0 24px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); background: var(--bg-panel); flex-shrink: 0; }
  .brand { font-family: var(--font-brand); font-weight: 700; font-size: 24px; color: #fff; letter-spacing: -0.02em; display: flex; align-items: center; gap: 12px; }
  .logo-icon { width: 28px; height: 28px; stroke: #818cf8; }
  .brand-text { background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .badge { font-family: 'Inter', sans-serif; font-size: 11px; background: #27272a; color: #fff; padding: 3px 8px; border-radius: 6px; border: 1px solid var(--border); transform: translateY(-1px); }

  /* Layout */
  .workspace { display: flex; flex: 1; height: calc(100vh - 60px); overflow: hidden; }
  .stage { flex: 1; background: #09090b; position: relative; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
  
  /* Welcome */
  .welcome-container { width: 100%; max-width: 800px; padding: 40px 20px; display: flex; flex-direction: column; align-items: center; min-height: 100%; }
  .upload-box { border: 2px dashed var(--border); border-radius: 16px; padding: 40px; text-align: center; background: rgba(255,255,255,0.02); cursor: pointer; transition: 0.2s; width: 100%; max-width: 500px; margin-bottom: 60px; }
  .upload-box:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); }
  .upload-icon-svg { width: 64px; height: 64px; stroke: var(--text-muted); margin-bottom: 16px; opacity: 0.5; }
  .upload-text { font-size: 18px; font-weight: 600; color: var(--text-main); margin-bottom: 8px; display: block; }

  /* Editor */
  #editorState { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; display: none; }
  
  /* Gallery Bar */
  .gallery-wrapper { width: 100%; background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 12px; min-height: 84px; flex-shrink: 0; }
  .gallery-bar { flex: 1; display: flex; gap: 10px; overflow-x: auto; white-space: nowrap; align-items: center; padding: 12px 0; scrollbar-width: none; -ms-overflow-style: none; }
  .gallery-bar::-webkit-scrollbar { display: none; }
  .gallery-controls { padding-left: 12px; border-left: 1px solid var(--border); margin-left: 12px; display: flex; align-items: center; }
  .icon-btn { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-muted); width: 36px; height: 36px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
  .icon-btn:hover { background: #323238; color: #fff; }
  .icon-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

  /* Gallery Item with Delete */
  .gallery-item { position: relative; display: flex; flex-shrink: 0; }
  .thumb { width: 60px; height: 60px; border-radius: 8px; border: 2px solid transparent; cursor: pointer; object-fit: cover; opacity: 0.6; transition: 0.2s; flex-shrink: 0; }
  .thumb:hover { opacity: 1; }
  .thumb.active { border-color: var(--primary); opacity: 1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3); }
  .gallery-bar.original-mode .thumb { width: auto; object-fit: contain; background: rgba(0,0,0,0.2); }
  
  .del-btn { position: absolute; top: -6px; right: -6px; width: 18px; height: 18px; background: #ef4444; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; cursor: pointer; opacity: 0; transition: 0.2s; border: 1px solid #18181b; z-index: 10; font-weight: bold; }
  .gallery-item:hover .del-btn { opacity: 1; }
  .del-btn:hover { transform: scale(1.1); }

  .canvas-container { box-shadow: var(--shadow); border-radius: 8px; overflow: hidden; background-image: linear-gradient(45deg, #1c1c1c 25%, transparent 25%), linear-gradient(-45deg, #1c1c1c 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #1c1c1c 75%), linear-gradient(-45deg, transparent 75%, #1c1c1c 75%); background-size: 20px 20px; background-color: #121212; border: 1px solid #333; touch-action: none; margin-top: 20px; margin-bottom: 20px; }
  canvas { display: block; max-width: 100%; height: auto; cursor: grab; }
  canvas:active { cursor: grabbing; }

  /* Canvas Controls (Moved to Sidebar) */
  .canvas-control-bar { display: flex; gap: 10px; align-items: center; margin-bottom: 16px; padding: 8px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; }
  .bar-sep { width: 1px; background: var(--border); height: 24px; margin: 0 2px; }
  .tool-btn { background: transparent; border: none; color: var(--text-muted); padding: 4px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
  .tool-btn:hover { color: #fff; }
  
  /* Sidebar */
  .sidebar { width: 340px; background: var(--bg-panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; height: 100%; }
  .sidebar-content { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 24px; }
  .sidebar-footer { flex-shrink: 0; padding: 20px 24px; background: var(--bg-panel); border-top: 1px solid var(--border); z-index: 20; }

  h3 { font-size: 11px; text-transform: uppercase; color: var(--primary); margin: 0 0 12px 0; font-weight: 800; letter-spacing: 1px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 6px; }
  input, select { width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: white; padding: 10px 12px; border-radius: 8px; font-size: 13px; margin-bottom: 5px; }
  input:focus, select:focus { border-color: var(--primary); }
  
  .btn-primary { background: var(--primary); color: white; width: 100%; padding: 14px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition:0.2s; }
  .btn-primary:hover { background: var(--primary-hover); }
  .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); width: 100%; padding: 10px; border-radius: 8px; cursor: pointer; margin-top: 8px; font-size: 12px; }
  .btn-ghost:hover { color: var(--text-main); border-color: var(--text-muted); }
  
  /* Product Shot Special Button */
  .btn-magic { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); color: white; width: 100%; padding: 14px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; margin-bottom: 8px; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); display: flex; align-items: center; justify-content: center; gap: 8px; }
  .btn-magic:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6); }

  input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 0; cursor: pointer; }
  input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #3f3f46; border-radius: 2px; }
  input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: #fff; margin-top: -5px; box-shadow: 0 2px 4px rgba(0,0,0,0.5); transition: transform 0.1s; }
  input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }
  .check-row { display: flex; align-items: center; justify-content: space-between; font-size: 13px; padding: 4px 0; cursor: pointer; }
  .check-row input { width: auto; margin: 0; accent-color: var(--primary); }

  /* SEO & Footer */
  .seo-section { max-width: 700px; width: 100%; color: var(--text-muted); line-height: 1.6; font-size: 15px; text-align: left; margin-top: 20px; padding-top: 40px; border-top: 1px solid var(--border); }
  .seo-section h2 { color: var(--text-main); font-size: 20px; margin-top: 30px; font-family: var(--font-brand); }
  .app-footer { margin-top: 60px; padding-top: 20px; border-top: 1px solid var(--border); width: 100%; text-align: center; font-size: 13px; color: var(--text-muted); padding-bottom: 40px; }
  .footer-links { display: flex; gap: 20px; justify-content: center; margin-bottom: 10px; }
  .footer-links a { color: var(--text-muted); text-decoration: none; cursor: pointer; }

  /* Modals */
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
  .modal-box { background: var(--bg-panel); width: 90%; max-width: 600px; max-height: 80vh; border-radius: 16px; border: 1px solid var(--border); display: flex; flex-direction: column; box-shadow: var(--shadow); transform: scale(0.95) translateY(10px); transition: transform 0.3s; }
  .modal-overlay.active { opacity: 1; }
  .modal-overlay.active .modal-box { transform: scale(1) translateY(0); }
  .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .modal-title { font-weight: 700; color: var(--text-main); }
  .modal-body { padding: 24px; overflow-y: auto; color: var(--text-muted); line-height: 1.6; font-size: 14px; }
  .close-modal { background: none; border: none; font-size: 24px; color: var(--text-muted); cursor: pointer; }
  .contact-btn { display: inline-block; background: var(--primary); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; margin-top: 10px; }

  .hidden { display: none !important; }

  @media (max-width: 900px) { 
    body { height: auto; overflow-y: auto; }
    .workspace { flex-direction: column; height: auto; overflow: visible; }
    .stage { min-height: 60vh; height: auto; padding-bottom: 40px; }
    .sidebar { width: 100%; height: auto; border-left: none; border-top: 1px solid var(--border); flex-shrink: 0; }
    .sidebar-content { overflow: visible; height: auto; }
    .sidebar-footer { position: relative; border-top: 1px solid var(--border); z-index: 1; }
  }
</style>
</head>
<body>

  <div id="modalOverlay" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-header"><span id="modalTitle" class="modal-title">Policy</span><button class="close-modal" onclick="closeModal()">Ã—</button></div>
      <div id="modalBody" class="modal-body"></div>
    </div>
  </div>

  <header class="topbar">
    <div class="brand">
      <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
        <path d="M19 9h1a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-9a2 2 0 0 1-2-2v-1"/>
        <path d="M10 9h4a1 1 0 0 1 1 1v4"/>
      </svg>
      <div class="brand-text">FitFrame</div> <span class="badge">PRO</span>
    </div>
    <div><a href="#" style="color:var(--text-muted); font-size:12px; text-decoration:none">v4.7 Final</a></div>
  </header>

  <div class="workspace">
    <main class="stage">
      <div id="welcomeState" class="welcome-container">
        <label id="dropzone" class="upload-box">
            <input id="file" type="file" accept="image/*" multiple class="hidden" />
            <svg class="upload-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
            <span class="upload-text">Upload Images to Start</span>
            <span style="font-size:13px; color:var(--text-muted)">Drag & Drop Multiple Files â€¢ JPG, PNG, WebP</span>
        </label>
        <section class="seo-section">
          <h2>The Ultimate Free Online Image Editor & Cropper</h2>
          <p>FitFrame Pro is a powerful, secure, and free online tool designed for creators. Unlike traditional image editors that require heavy installations or unsafe uploads, FitFrame runs entirely in your browser.</p>
          <h2>Key Features</h2>
          <ul>
              <li><strong>Batch Editing:</strong> Upload up to 10 images. Edit individually, download seamlessly.</li>
              <li><strong>Smart Cropping:</strong> Pre-set aspect ratios (1:1, 4:5, 9:16).</li>
              <li><strong>Product Mode:</strong> Instantly create centered, white-background product shots.</li>
              <li><strong>Privacy-First:</strong> Client-side processing (HTML5 Canvas). Zero uploads.</li>
          </ul>
        </section>
        <footer class="app-footer">
          <div class="footer-links">
            <a onclick="openModal('privacy')">Privacy</a>
            <a onclick="openModal('terms')">Terms</a>
            <a onclick="openModal('contact')">Contact</a>
          </div>
          <div>&copy; 2025 FitFrame Pro. All rights reserved.</div>
        </footer>
      </div>

      <div id="editorState">
        <div class="gallery-wrapper">
          <div id="galleryBar" class="gallery-bar"></div>
          <div class="gallery-controls">
            <button id="alignBtn" class="icon-btn active" title="Toggle Alignment">
              <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/></svg>
            </button>
          </div>
        </div>
        <div class="canvas-container"><canvas id="canvas"></canvas></div>
      </div>
    </main>

    <aside class="sidebar">
      <div class="sidebar-content">
        <h3>Layout & Controls</h3>
        
        <div class="canvas-control-bar">
          <button id="resetBtn" class="tool-btn" title="Reset View"><svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg></button>
          <button id="fitBtn" class="tool-btn" title="Zoom to Fit"><svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg></button>
          <div class="bar-sep"></div>
          <span style="font-size:11px; color:var(--text-muted); font-weight:600;">OVERLAY</span>
          <input id="overlayRange" type="range" min="0" max="0.9" step="0.05" value="0" style="flex:1" />
        </div>
        
        <button id="productShotBtn" class="btn-magic">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
          Instant Product Shot (700x850)
        </button>
        <label class="check-row" style="margin-bottom:12px"><span>Apply to All Uploaded Images</span><input id="applyToAll" type="checkbox"></label>

        <div style="height:1px; background:var(--border); margin:16px 0"></div>

        <label>Preset Size</label>
        <select id="preset"><option value="1000x1000">Square (1:1)</option><option value="1080x1350">IG Portrait (4:5)</option><option value="1080x1920">Story (9:16)</option><option value="1200x628">Twitter/Link</option><option value="700x850">Product (700x850)</option><option value="custom">Custom...</option></select>
        <div id="customSize" class="hidden" style="display:flex; gap:10px"><input id="outW" type="number" value="1000"><input id="outH" type="number" value="1000"></div>
        
        <label>Content Fit</label>
        <select id="contentFit">
          <option value="cover">Cover (fill & crop)</option>
          <option value="contain">Contain (fit & pad)</option>
        </select>
        
        <label>Background</label>
        <select id="bgSelect"><option value="transparent">Transparent</option><option value="#ffffff">White</option><option value="#000000">Black</option></select>
        <label class="check-row"><span>Auto Fill Background (Image Color)</span><input id="autoFill" type="checkbox"></label>
        
        <label class="check-row"><span style="display:flex;align-items:center;gap:6px">ðŸ”´ Circle Crop (Profile)</span><input id="circleCrop" type="checkbox"></label>
        <div style="height:1px; background:var(--border); margin:10px 0"></div>

        <h3>Export</h3>
        <div style="display:flex; gap:10px"><select id="format"><option value="image/png">PNG</option><option value="image/jpeg">JPG</option><option value="image/webp">WebP</option><option value="image/svg+xml">SVG</option></select></div>
        <div id="qualityWrap" class="hidden"><label>Quality: <span id="qval">0.9</span></label><input id="quality" type="range" min="0.1" max="1" step="0.1" value="0.9"></div>
        <label class="check-row"><span>Prevent Upscaling</span><input id="noUpscale" type="checkbox"></label>
        <label class="check-row"><span>Auto-fit on Export</span><input id="fitExport" type="checkbox"></label>
      </div>

      <div class="sidebar-footer">
        <div class="stats" style="background:rgba(99,102,241,0.1); padding:12px; border-radius:8px; display:flex; justify-content:space-between; font-size:12px; margin-bottom:10px">
          <span><strong id="showW">1000</strong> x <strong id="showH">1000</strong></span><span id="sizeEstimate">Est: --</span>
        </div>
        <button id="exportBtn" class="btn-primary">Download Current</button>
        <button id="downloadAllBtn" class="btn-ghost" onclick="downloadAll()">Download All Images</button>
      </div>
    </aside>
  </div>

<script>
const canvas=document.getElementById('canvas'), ctx=canvas.getContext('2d',{alpha:true});
const fileIn=document.getElementById('file'), dropzone=document.getElementById('dropzone');
const welcomeState=document.getElementById('welcomeState'), editorState=document.getElementById('editorState');
const galleryBar=document.getElementById('galleryBar');
let queue=[], activeIdx=0, img=new Image(), imgLoaded=false;

// --- Persistence Helpers ---
function saveSettings(){
  localStorage.setItem('fitframe_w', state.w);
  localStorage.setItem('fitframe_h', state.h);
  localStorage.setItem('fitframe_fit', state.contentFit);
  localStorage.setItem('fitframe_bg', state.bg);
  localStorage.setItem('fitframe_autofill', state.autoFill);
}
function loadSettings(){
  const w = localStorage.getItem('fitframe_w');
  const h = localStorage.getItem('fitframe_h');
  const fit = localStorage.getItem('fitframe_fit');
  const bg = localStorage.getItem('fitframe_bg');
  const af = localStorage.getItem('fitframe_autofill');
  return {
    w: w ? Number(w) : 1000,
    h: h ? Number(h) : 1000,
    contentFit: fit || 'cover',
    bg: bg || 'transparent',
    autoFill: af === 'true'
  };
}
const saved = loadSettings();

const defaultProps=()=>({
  tx:0, ty:0, scale:1, rot:0, flipH:1, flipV:1, bri:100, con:100, gry:0, circle:false,
  w:saved.w, h:saved.h,
  fitExport:false, noUpscale:false,
  bg:saved.bg,
  format:'image/png', q:0.9,
  contentFit:saved.contentFit,
  autoFill:saved.autoFill,
  dominantColor: null
});
let state=defaultProps();

// Initialize UI with saved settings
const preset = document.getElementById('preset');
const custom = document.getElementById('customSize');
const outW=document.getElementById('outW'), outH=document.getElementById('outH');

outW.value = saved.w;
outH.value = saved.h;
document.getElementById('contentFit').value = saved.contentFit;
document.getElementById('bgSelect').value = saved.bg;
document.getElementById('autoFill').checked = saved.autoFill;

// Attempt to set preset dropdown if matches common sizes
const ps = `${saved.w}x${saved.h}`;
if([...preset.options].map(o=>o.value).includes(ps)) {
  preset.value = ps;
  custom.classList.add('hidden');
} else { 
  preset.value = 'custom'; 
  custom.classList.remove('hidden'); 
}

const alignBtn = document.getElementById('alignBtn');
alignBtn.onclick=()=>{galleryBar.classList.toggle('original-mode'); alignBtn.classList.toggle('active');};

const modalText={privacy:`<strong>Privacy Policy</strong><br><span style="font-size:12px;color:var(--text-muted)">Updated: Nov 2025</span><br><br><strong>1. Introduction</strong><br>Welcome to FitFrame.<br><strong>2. Local Processing</strong><br>We do not upload images.`,terms:`<strong>Terms</strong><br>Free use. No warranty.`,contact:`<strong>Contact Us</strong><br><br>Email: <a href="mailto:support@fitframe.in" class="contact-btn">support@fitframe.in</a>`};
function openModal(t){document.getElementById('modalTitle').innerText=t==='contact'?'Contact':t;document.getElementById('modalBody').innerHTML=modalText[t];const o=document.getElementById('modalOverlay');o.style.display='flex';setTimeout(()=>o.classList.add('active'),10);}
function closeModal(){const o=document.getElementById('modalOverlay');o.classList.remove('active');setTimeout(()=>o.style.display='none',300);}
document.getElementById('modalOverlay').onclick=e=>{if(e.target.id==='modalOverlay')closeModal();}

function setView(h){if(h){welcomeState.style.display='none';editorState.style.display='flex';}else{welcomeState.style.display='flex';editorState.style.display='none';}}
function loadFiles(fs){
  if(!fs||fs.length===0)return; let cnt=0;
  Array.from(fs).forEach(f=>{ if(cnt>=10||!f.type.startsWith('image/'))return; queue.push({file:f,url:URL.createObjectURL(f),name:f.name,props:defaultProps()}); cnt++; });
  if(queue.length>0){activeIdx=queue.length-cnt; loadActiveImage(); renderGallery();}
}

function getDominantColor(imgEl) {
  const c = document.createElement('canvas');
  c.width=1; c.height=1;
  const cx = c.getContext('2d');
  // UPDATED: Use 9-arg syntax to strictly grab the top-left pixel (0,0) only.
  // This ensures solid color borders (like the pink bar in your logo) are perfectly matched
  // instead of averaging the whole image.
  cx.drawImage(imgEl, 0, 0, 1, 1, 0, 0, 1, 1);
  const p = cx.getImageData(0,0,1,1).data;
  return `rgb(${p[0]},${p[1]},${p[2]})`;
}

function loadActiveImage(){
  if(queue.length===0) return;
  const it=queue[activeIdx]; const i=new Image();
  i.onload=()=>{
    img=i;state=it.props;imgLoaded=true;
    // Calculate dominant color if missing
    if(!state.dominantColor) state.dominantColor = getDominantColor(img);
    updateUI(); setView(true); 
    if(state.scale===1){setVisualSize();fitImage();}else{setVisualSize();render();} 
    updateEst();
  };
  i.src=it.url;
}
function renderGallery(){
  galleryBar.innerHTML=''; 
  queue.forEach((it,ix)=>{
    const wrapper = document.createElement('div');
    wrapper.className = 'gallery-item';
    
    const d=document.createElement('img'); 
    d.className=`thumb ${ix===activeIdx?'active':''}`; 
    d.src=it.url;
    d.onclick=()=>{if(ix!==activeIdx){activeIdx=ix;loadActiveImage();renderGallery();}};
    
    const btn = document.createElement('div');
    btn.className='del-btn';
    btn.innerHTML='Ã—';
    btn.onclick=(e)=>{ e.stopPropagation(); deleteImage(ix); };

    wrapper.appendChild(d);
    wrapper.appendChild(btn);
    galleryBar.appendChild(wrapper);
  });
}

function deleteImage(ix){
  if(ix < 0 || ix >= queue.length) return;
  queue.splice(ix, 1);
  if(queue.length === 0){
    imgLoaded=false; setView(false); activeIdx=0;
  } else {
    if(ix === activeIdx) {
      // If deleted active, go to nearest (or prev if was last)
      activeIdx = Math.min(ix, queue.length - 1);
      loadActiveImage();
    } else if (ix < activeIdx) {
      // If deleted one before active, decrement index to stay on current
      activeIdx--;
    }
    renderGallery();
  }
}

// PRODUCT SHOT LOGIC (Updated with "Apply to All")
document.getElementById('productShotBtn').onclick = () => {
  if(!imgLoaded) return;
  
  // Define the target settings
  const targetSettings = {
    w: 700, h: 850,
    bg: '#ffffff',
    contentFit: 'contain',
    fitExport: true,
    autoFill: false // usually product shots want pure white
  };

  const applyToAll = document.getElementById('applyToAll').checked;

  if(applyToAll) {
    // Apply to EVERY image in queue
    queue.forEach(item => {
      Object.assign(item.props, targetSettings);
    });
    // Update current state reference to match current active item
    state = queue[activeIdx].props;
  } else {
    // Apply only to current image
    Object.assign(state, targetSettings);
  }

  updateUI(); // Refresh checkboxes/dropdowns
  render();   // Re-render canvas
  updateEst();
  saveSettings();
};

function updateUI(){
  document.getElementById('circleCrop').checked=state.circle; 
  document.getElementById('outW').value=state.w; document.getElementById('outH').value=state.h;
  document.getElementById('noUpscale').checked=state.noUpscale; document.getElementById('fitExport').checked=state.fitExport;
  document.getElementById('bgSelect').value=state.bg; document.getElementById('format').value=state.format;
  document.getElementById('contentFit').value=state.contentFit;
  document.getElementById('autoFill').checked=state.autoFill;
  document.getElementById('showW').innerText=state.w; document.getElementById('showH').innerText=state.h;
}

fileIn.onchange=e=>loadFiles(e.target.files); dropzone.onclick=()=>fileIn.click();
window.ondrop=e=>{e.preventDefault();loadFiles(e.dataTransfer.files);}; window.ondragover=e=>e.preventDefault();

document.getElementById('circleCrop').onchange=e=>{state.circle=e.target.checked;render();updateEst();}
document.getElementById('noUpscale').onchange=e=>{state.noUpscale=e.target.checked; updateEst();}
document.getElementById('fitExport').onchange=e=>{state.fitExport=e.target.checked; render();}
document.getElementById('contentFit').onchange=e=>{state.contentFit=e.target.value; render(); updateEst(); saveSettings();}
document.getElementById('autoFill').onchange=e=>{state.autoFill=e.target.checked; render(); updateEst(); saveSettings();}

preset.onchange=()=>{ 
  if(preset.value==='custom') custom.classList.remove('hidden'); 
  else { 
    custom.classList.add('hidden'); 
    const[w,h]=preset.value.split('x').map(Number); 
    state.w=w; state.h=h; outW.value=w; outH.value=h; updateDims(); 
    saveSettings();
  } 
}
[outW,outH].forEach(i=>i.oninput=()=>{
  state.w=Number(outW.value);state.h=Number(outH.value);
  updateDims(); saveSettings();
});
function updateDims(){ document.getElementById('showW').innerText=state.w; document.getElementById('showH').innerText=state.h; if(imgLoaded){setVisualSize();updateEst();} }
const format=document.getElementById('format'), quality=document.getElementById('quality');
quality.oninput=()=>{state.q=Number(quality.value);document.getElementById('qval').textContent=quality.value;updateEst();}
format.onchange=()=>{state.format=format.value;document.getElementById('qualityWrap').classList.toggle('hidden',format.value!=='image/jpeg'&&format.value!=='image/webp');updateEst();}
document.getElementById('bgSelect').onchange=e=>{state.bg=e.target.value; render(); updateEst(); saveSettings();}

function render(){
  if(!imgLoaded)return; ctx.clearRect(0,0,canvas.width,canvas.height);
  
  // Auto Fill / Background logic
  let bg = state.bg;
  if(state.autoFill && state.dominantColor) bg = state.dominantColor;
  if(!state.circle && bg!=='transparent') {
    ctx.fillStyle = bg;
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }

  ctx.save(); ctx.translate(canvas.width/2+state.tx, canvas.height/2+state.ty); ctx.scale(state.scale, state.scale);
  ctx.rotate(state.rot*Math.PI/180); ctx.scale(state.flipH, state.flipV);
  ctx.filter=`brightness(${state.bri}%) contrast(${state.con}%) grayscale(${state.gry}%)`;
  ctx.drawImage(img,-img.width/2,-img.height/2); ctx.restore();
  if(state.circle){ ctx.save(); ctx.fillStyle='rgba(0,0,0,0.8)'; ctx.beginPath(); ctx.rect(0,0,canvas.width,canvas.height); ctx.arc(canvas.width/2, canvas.height/2, Math.min(canvas.width,canvas.height)/2, 0, 2*Math.PI, true); ctx.fill(); ctx.restore(); }
  else { const ov=Number(document.getElementById('overlayRange').value); if(ov>0){ ctx.fillStyle=`rgba(0,0,0,${ov})`; ctx.fillRect(0,0,canvas.width,canvas.height); } }
}
function fitImage(){state.scale=Math.min(canvas.width/img.width, canvas.height/img.height);state.tx=0;state.ty=0;render();}
function setVisualSize(){ const box=document.querySelector('.stage'); const r=state.w/state.h; let vw=Math.min(box.clientWidth-40,800); let vh=vw/r; if(vh>box.clientHeight-100){vh=box.clientHeight-100;vw=vh*r;} canvas.width=vw; canvas.height=vh; render(); }

let drag=false, lx=0, ly=0;
canvas.onmousedown=e=>{drag=true;lx=e.clientX;ly=e.clientY;}
window.onmouseup=()=>drag=false;
window.onmousemove=e=>{if(drag&&imgLoaded){state.tx+=e.clientX-lx;state.ty+=e.clientY-ly;lx=e.clientX;ly=e.clientY;render();}}
let ipd=0;
canvas.addEventListener('touchstart',e=>{if(e.touches.length===1){drag=true;lx=e.touches[0].clientX;ly=e.touches[0].clientY;}else if(e.touches.length===2){drag=false;ipd=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);}},{passive:false});
canvas.addEventListener('touchmove',e=>{if(e.touches.length===1&&drag&&imgLoaded){e.preventDefault();const x=e.touches[0].clientX,y=e.touches[0].clientY;state.tx+=x-lx;state.ty+=y-ly;lx=x;ly=y;render();}else if(e.touches.length===2&&imgLoaded){e.preventDefault();const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);if(ipd>0){state.scale*=d/ipd;ipd=d;render();updateEst();}}},{passive:false});
canvas.addEventListener('touchend',()=>drag=false);
canvas.onwheel=e=>{e.preventDefault();state.scale*=Math.exp(-e.deltaY*0.001);render();updateEst();}
document.getElementById('fitBtn').onclick=fitImage; document.getElementById('resetBtn').onclick=fitImage; document.getElementById('overlayRange').oninput=render;

async function genBlob(st, el){
  let w=st.w, h=st.h;
  if(st.noUpscale){if(w>el.width||h>el.height){const r=Math.min(el.width/w,el.height/h);w=Math.round(w*r);h=Math.round(h*r);}}
  const c=document.createElement('canvas');c.width=w;c.height=h;const x=c.getContext('2d');
  
  // Export Background Logic
  let bg = st.bg;
  if(st.autoFill && st.dominantColor) bg = st.dominantColor;

  if(st.circle)x.clearRect(0,0,w,h);
  else if(bg!=='transparent'){x.fillStyle=bg;x.fillRect(0,0,w,h);}
  
  if(st.circle){x.beginPath();x.arc(w/2,h/2,Math.min(w,h)/2,0,2*Math.PI);x.clip();}
  x.save();
  
  let s, tx=0, ty=0;
  if(st.contentFit === 'contain') {
     s = Math.min(w / el.width, h / el.height);
     tx = (w - el.width * s) / 2;
     ty = (h - el.height * s) / 2;
     x.translate(tx + el.width*s/2, ty + el.height*s/2);
     x.scale(s, s);
  } else if(st.fitExport){
     s=Math.max(w/el.width,h/el.height); 
     x.translate(w/2,h/2); x.scale(s,s);
  } else {
     const r=w/canvas.width; x.translate(w/2+st.tx*r,h/2+st.ty*r); x.scale(st.scale*r,st.scale*r);
  }

  x.rotate(st.rot*Math.PI/180); x.scale(st.flipH, st.flipV);
  x.filter=`brightness(${st.bri}%) contrast(${st.con}%) grayscale(${st.gry}%)`;
  x.drawImage(el,-el.width/2,-el.height/2); x.restore();
  return new Promise(r=>c.toBlob(b=>r(b),st.format,st.q));
}

document.getElementById('exportBtn').onclick=async()=>{
  if(!imgLoaded)return alert('Load image'); const b=await genBlob(state,img); const e=state.format.split('/')[1];
  const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`${queue[activeIdx].name.split('.')[0]}-edit.${e}`;a.click();
}
async function downloadAll(){
  if(queue.length===0)return alert('No images');
  for(let i=0;i<queue.length;i++){
    const t=new Image();t.src=queue[i].url; await new Promise(r=>t.onload=r);
    // Ensure dominant color is calculated if missing for batch
    if(queue[i].props.autoFill && !queue[i].props.dominantColor) queue[i].props.dominantColor = getDominantColor(t);
    const b=await genBlob(queue[i].props,t); const e=queue[i].props.format.split('/')[1];
    const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`${queue[i].name.split('.')[0]}-edit.${e}`;a.click();
    await new Promise(r=>setTimeout(r,500));
  }
}
async function updateEst(){if(!imgLoaded){document.getElementById('sizeEstimate').innerText='Est: --';return;}const b=await genBlob(state,img);if(b)document.getElementById('sizeEstimate').innerText=`Est: ~${Math.round(b.size/1024)} KB`;}
</script>
</body>
</html>
